<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>multi snake</title>
    <style>
        * { margin: 0; padding: 0;}

        body, html {
            height:100%;
            overflow: hidden;
            flex-direction: column;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            background: darkslategray;
        }

        #canvas {
            border: 1px solid cadetblue;
            background: black;
        }

        #controls {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button id="connect">connect</button>
        <button id="stop">stop</button>
    </div>
    <canvas id="canvas"></canvas>
</body>

<script>
    const Direction = {
        UP: 'up',
        DOWN: 'down',
        LEFT: 'left',
        RIGHT: 'right'
    }

    const KeyCode = {
        ArrowUp: 'ArrowUp',
        ArrowDown: 'ArrowDown',
        ArrowRight: 'ArrowRight',
        ArrowLeft: 'ArrowLeft',
    }

    const colors = {
        background: 'black'
    }

    class Renderer {
        resolution = {
            width: 80,
            height: 60
        };
        client = {
            width: 640,
            height: 480,
        }

        pixel = {
            width: this.client.width / this.resolution.width,
            height: this.client.height / this.resolution.height
        }

        constructor() {
            const canvas = document.getElementById('canvas');
            canvas.width = this.client.width;
            canvas.height = this.client.height;

            this.ctx = canvas.getContext("2d");
        }

        drawPoint(x, y, color) {
            this.ctx.save();
            this.ctx.beginPath();

            this.ctx.fillStyle = color;
            this.ctx.strokeStyle = 'red';

            const topLeft = {
                x: x * this.pixel.width,
                y: y * this.pixel.height,
            }


            this.ctx.rect(topLeft.x, topLeft.y, this.pixel.height, this.pixel.width);

            this.ctx.fill();
            this.ctx.stroke();

            this.ctx.restore();
        }

        clear() {
            this.ctx.fillStyle = 'green';
            this.ctx.clearRect(0, 0, this.client.width, this.client.height)
        }
    }

    class Snake {
        color = 'white'

        constructor(renderer) {
            this.renderer = renderer;

        }

        update(body) {
            this.body = body;
        }

        draw() {
            this.body.forEach(point => {
                this.renderer.drawPoint(point.x, point.y, this.color)
            })
        }
    }

    const renderer = new Renderer();
    const snakes = [new Snake(renderer), new Snake(renderer)]

    function tick(data) {
        renderer.clear();
        snakes.forEach((snake, i) => {
            snake.update(data.players[i].body)
            snake.draw();
        })
    }


    const webSocket = new WebSocket('ws://localhost:8080/ws/');

    const connectButton = document.getElementById('connect');
    const disconnectButton = document.getElementById('stop');

    connectButton.addEventListener('click', () => {
        webSocket.send("/connect");

    })

    disconnectButton.addEventListener('click', () => {
        webSocket.send("/stop");
    })

    webSocket.addEventListener('open', (event) => {
    });


    webSocket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        tick(data);
    }


    window.addEventListener("keydown", (event) => {
        const eventMap = {
            [KeyCode.ArrowLeft]: Direction.LEFT,
            [KeyCode.ArrowRight]: Direction.RIGHT,
            [KeyCode.ArrowUp]: Direction.UP,
            [KeyCode.ArrowDown]: Direction.DOWN,
        };

        webSocket.send(eventMap[event.key]);
    });


</script>

</html>